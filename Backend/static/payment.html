<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Make Payment</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- JS -->
    <!-- <script src="/static/Js/script.js"></script> -->

    <!-- Favicon -->
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" />

    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-500 flex items-center justify-center min-h-screen">
    <style>
      /* From Uiverse.io by david-mohseni */
      .loader {
        position: relative;
        width: 54px;
        height: 54px;
        border-radius: 10px;
      }

      .loader div {
        width: 8%;
        height: 24%;
        background: rgb(128, 128, 128);
        position: absolute;
        left: 50%;
        top: 30%;
        opacity: 0;
        border-radius: 50px;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.2);
        animation: fade458 1s linear infinite;
      }

      @keyframes fade458 {
        from {
          opacity: 1;
        }

        to {
          opacity: 0.25;
        }
      }

      .loader .bar1 {
        transform: rotate(0deg) translate(0, -130%);
        animation-delay: 0s;
      }

      .loader .bar2 {
        transform: rotate(30deg) translate(0, -130%);
        animation-delay: -1.1s;
      }

      .loader .bar3 {
        transform: rotate(60deg) translate(0, -130%);
        animation-delay: -1s;
      }

      .loader .bar4 {
        transform: rotate(90deg) translate(0, -130%);
        animation-delay: -0.9s;
      }

      .loader .bar5 {
        transform: rotate(120deg) translate(0, -130%);
        animation-delay: -0.8s;
      }

      .loader .bar6 {
        transform: rotate(150deg) translate(0, -130%);
        animation-delay: -0.7s;
      }

      .loader .bar7 {
        transform: rotate(180deg) translate(0, -130%);
        animation-delay: -0.6s;
      }

      .loader .bar8 {
        transform: rotate(210deg) translate(0, -130%);
        animation-delay: -0.5s;
      }

      .loader .bar9 {
        transform: rotate(240deg) translate(0, -130%);
        animation-delay: -0.4s;
      }

      .loader .bar10 {
        transform: rotate(270deg) translate(0, -130%);
        animation-delay: -0.3s;
      }

      .loader .bar11 {
        transform: rotate(300deg) translate(0, -130%);
        animation-delay: -0.2s;
      }

      .loader .bar12 {
        transform: rotate(330deg) translate(0, -130%);
        animation-delay: -0.1s;
      }
    </style>
    <div
      class="bg-white shadow-lg rounded-2xl flex w-full max-w-5xl overflow-hidden"
    >
      <!-- Tabs (Left) -->
      <div class="flex flex-col items-start p-4 space-y-4 bg-gray-50 w-20">
        <button
          id="tab-card"
          class="w-full flex items-center justify-center bg-green-500 text-white p-3 rounded-lg shadow cursor-pointer"
          title="Card"
        >
          üí≥
        </button>
        <button
          id="tab-transfer"
          class="w-full flex items-center justify-center bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 cursor-pointer"
          title="Bank Transfer"
        >
          üè¶
        </button>
        <button
          id="tab-wallet"
          class="w-full flex items-center justify-center bg-gray-200 text-gray-700 p-3 rounded-lg hover:bg-gray-300 cursor-pointer"
          title="Wallet"
        >
          üëõ
        </button>
      </div>

      <!-- Form (Right) -->
      <div class="flex-1 p-8 flex flex-col" id="whole_form">
        <!-- From Uiverse.io by david-mohseni -->
        <div class="loader hidden">
          <div class="bar1"></div>
          <div class="bar2"></div>
          <div class="bar3"></div>
          <div class="bar4"></div>
          <div class="bar5"></div>
          <div class="bar6"></div>
          <div class="bar7"></div>
          <div class="bar8"></div>
          <div class="bar9"></div>
          <div class="bar10"></div>
          <div class="bar11"></div>
          <div class="bar12"></div>
        </div>

        <!-- evertything -->
        <div class="everything">
          <!-- Back Button -->
          <button
            id="back-btn"
            title="Back to Dashboard"
            class="flex items-center gap-2 text-gray-600 hover:text-blue-600 mb-6"
          >
            <!-- Back Arrow SVG -->
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              />
            </svg>
            <span></span>
          </button>

          <div class="flex justify-between">
            <div class="flex gap-2 mb-4 mt-2">
              <div
                class="w-10 h-10 flex items-center justify-center rounded-full border-2 border-cyan-400 text-cyan-400 font-bold text-lg"
              >
                P
              </div>
              <h2 class="text-2xl text-cyan-400">Payverge</h2>
            </div>

            <div class="top-2 right-10">
              <div class="flex justify-between space-x-2">
                <p class="block text-gray-600">Email:</p>
                <input
                  id="email"
                  type="email"
                  readonly
                  class="rounded-lg cursor-not-allowed"
                />
              </div>
              <div class="flex justify-between space-x-2">
                <div class="flex justify-between space-x-2">
                  <label class="block text-gray-600">Pay</label>
                </div>
                <input
                  id="amount"
                  type="text"
                  readonly
                  class="w-full block text-green-600 rounded-lg cursor-not-allowed"
                />
              </div>
            </div>
          </div>

          <span class="text-2xl font-bold top-2">Complete Your Payment</span>

          <!-- Card MOCK -->
          <div id="card-mock" class="mb-6">
            <div
              class="rounded-xl p-5 bg-gradient-to-r from-slate-800 to-slate-600 text-white shadow-md max-w-md"
            >
              <div class="text-xs opacity-80">VIRTUAL CARD</div>
              <div id="mock-number" class="text-xl tracking-widest mt-3">
                ####-####-####-####
              </div>
              <div class="flex justify-between mt-3 text-sm opacity-90">
                <div>EXP: <span id="mock-exp">MM/YY</span></div>
                <div>CVV: <span id="mock-cvv">***</span></div>
              </div>
              <div class="mt-4 text-xs opacity-80">NGN Payment</div>
            </div>
          </div>

          <!-- CARD FORM -->
          <div id="form-card" class="space-y-4">
            <div>
              <label class="block text-gray-600 mb-1">Card Number</label>
              <input
                id="card-number"
                type="text"
                inputmode="numeric"
                autocomplete="cc-number"
                maxlength="19"
                placeholder="1234-5678-9012-3456"
                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
              />
              <p id="err-card" class="text-red-600 text-sm mt-1 hidden">
                Invalid card number.
              </p>
            </div>
            <div class="flex gap-4">
              <div class="flex-1">
                <label class="block text-gray-600 mb-1">Expiry (MM/YY)</label>
                <input
                  id="expiry"
                  type="text"
                  inputmode="numeric"
                  autocomplete="cc-exp"
                  placeholder="MM/YY"
                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
                <p id="err-exp" class="text-red-600 text-sm mt-1 hidden">
                  Expiry date is invalid or past.
                </p>
              </div>
              <div class="flex-1">
                <label class="block text-gray-600 mb-1">CVV</label>
                <input
                  id="cvv"
                  type="password"
                  inputmode="numeric"
                  autocomplete="cc-csc"
                  placeholder="123"
                  class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
                <p id="err-cvv" class="text-red-600 text-sm mt-1 hidden">
                  CVV must be 3 digits.
                </p>
              </div>
            </div>
            <button
              id="pay-now"
              class="w-full mt-2 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2 top-2"
            >
              <span class="btn-text">Pay NGN</span>

              <svg
                class="animate-spin h-5 w-5 hidden"
                id="btn-spinner"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                  opacity=".25"
                ></circle>
                <path
                  d="M4 12a8 8 0 018-8"
                  stroke="currentColor"
                  stroke-width="4"
                  opacity=".75"
                ></path>
              </svg>
            </button>
            <p class="btn-text flex justify-center font-bold text-gray-800">
              Secured by Payverge
            </p>
          </div>

          <div id="form-transfer" class="space-y-6 hidden">
            <!-- TRANSFER FORM -->
            <!-- Transfer Header -->
            <!-- <h2 class="text-xl font-semibold text-gray-800 text-center">
            Complete Your Transfer
          </h2> -->

            <div
              class="bg-white shadow-md rounded-lg p-4 space-y-3 flex flex-col"
            >
              <p
                class="text-2xl text-red-500 uppercase bg-red-500 text-white text-center"
              >
                Note: Ensure to send the exact amount to the right account shown
                below
              </p>
              <p class="text-gray-600">Transfer amount (NGN)</p>
              <div class="flex">
                <h3
                  id="amount-transfered"
                  class="text-2xl font-bold text-green-600 flex-1"
                ></h3>
                <button
                  class="justify-end border-yellow-40 bg-yellow-400 px-4 py-2 text-lg hover:bg-cyan-400 rounded-lg shadow-lg disabled:bg-cyan-400"
                  id="copy-amount"
                >
                  Copy Amount
                </button>
              </div>
              <div class="border-t pt-3 space-y-2">
                <p class="text-gray-600">Account Number</p>
                <div class="flex">
                  <h4
                    id="account-number"
                    class="text-lg font-semibold text-gray-900 flex-1"
                  ></h4>
                  <button
                    class="justify-end bg-yellow-400 px-4 py-2 text-lg hover:bg-cyan-400 rounded-lg shadow-lg disabled:bg-cyan-400"
                    id="copy-account-number"
                  >
                    Copy Account Number
                  </button>
                </div>

                <p class="text-gray-600">Account Name</p>
                <div class="flex">
                  <h4
                    id="account-name"
                    class="text-lg font-semibold text-gray-900"
                  ></h4>
                </div>

                <p class="text-gray-600">Bank Name</p>
                <div class="flex">
                  <h4
                    id="bank-name"
                    class="text-lg font-semibold text-gray-900"
                  ></h4>
                </div>
              </div>
            </div>

            <div class="flex justify-center">
              <p class="text-lg text-yellow-600" id="timer">00:00</p>
              <!-- <button
                id="confirm-transfer"
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow-md"
              >
                I have sent the money
              </button> -->
            </div>
          </div>

          <!-- WALLET FORM -->
          <div id="form-wallet" class="space-y-4 hidden">
            <div>
              <label class="block text-gray-600 mb-1">Wallet ID / Email</label>
              <input
                id="wallet-id"
                type="text"
                placeholder="wallet@example.com"
                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <button
              id="wallet-btn"
              class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded w-full"
            >
              Pay from Wallet
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const BASE_URL = "https://payment-gateway-3.onrender.com";
        const formCard = document.querySelector("#form-card");
        const formTransfer = document.querySelector("#form-transfer");
        const formWallet = document.querySelector("#form-wallet");

        // Grab all tabs
        const tabCard = document.querySelector("#tab-card");
        const tabTransfer = document.querySelector("#tab-transfer");
        const tabWallet = document.querySelector("#tab-wallet");

        let loader = document.querySelector(".loader");
        let everything = document.querySelector(".everything");
        let whole_form = document.querySelector("#whole_form");
        let emailInput = document.querySelector("#email");
        let amountInput = document.querySelector("#amount");

        // loader.classList.remove("hidden");
        // everything.classList.add("hidden");
        // whole_form.classList.add("items-center", "justify-center");

        const transactionRefId = new URLSearchParams(
          window.location.search
        ).get("id");
        console.log("id", transactionRefId);
        localStorage.setItem("payment_id", transactionRefId);

        if (!transactionRefId)
          return console.error("Transaction reference missing");

        // === Fetch Payment Data ===
        async function fetchDataFromPaymentId(payment_id) {
          if (!payment_id) {
            throw new Error("Missing Payment ID");
          }
          const response = await fetch(
            `${BASE_URL}/api/v1/get_payment?id=${payment_id}`
          );
          return await response.json();
        }

        try {
          const {
            email: userEmail,
            amount: userAmount,
            owner_email,
          } = await fetchDataFromPaymentId(transactionRefId);

          // Stores values
          localStorage.setItem("owner_email", owner_email);
          localStorage.setItem("amount_to_send", userAmount);

          emailInput.value = userEmail || "N/A";
          amountInput.value = userAmount
            ? `‚Ç¶${Number(userAmount).toLocaleString()}`
            : "0";

          loader.classList.add("hidden");
          everything.classList.remove("hidden");
          whole_form.classList.remove("items-center", "justify-center");
        } catch (err) {
          console.error(err);
          Swal.fire({
            title: "Error",
            text: "Failed to load payment details.",
            icon: "error",
          });
        }

        // === BlinkPay Auth ===
        const loginUrl =
          "https://blink-pay-bank-app-backend.onrender.com/api/v1/auth/passwordless-login";
        const blinkPayVerifyOtpUrl =
          "https://blink-pay-bank-app-backend.onrender.com/api/v1/auth/verify-otp";
        const profileUrl =
          "https://blink-pay-bank-app-backend.onrender.com/api/v1/auth/profile";

        let payvergeSignIn = `${BASE_URL}/api/v1/signin`;
        let payvergeSignInVerifyOtp = `${BASE_URL}/api/v1/verify_otp`;

        const login = await fetch(loginUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: localStorage.getItem("owner_email") }),
        });
        const passwordlessResponse = await login.json();
        const passOtp = passwordlessResponse?.otp;
        console.log(passwordlessResponse);

        const blinkPayverify = await fetch(blinkPayVerifyOtpUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: localStorage.getItem("owner_email"),
            otp: passOtp,
          }),
        });
        const loginResponse = await blinkPayverify.json();

        let login_token = loginResponse?.token;
        localStorage.setItem("token", login_token);

        const profile = await fetch(profileUrl, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + login_token,
          },
        });
        const profileResponse = await profile.json();
        localStorage.setItem(
          "user_account_number",
          profileResponse?.user?.acc_number
        );
        localStorage.setItem("user_id", profileResponse?.user?.userId);
        console.log({
          profile_acc_num: profileResponse?.user?.acc_number,
          profileResponse,
        });

        // payverge

        async function loginToPayverge(signInLink, verifyOtpLink) {
          const the_owner_email = localStorage.getItem("owner_email");
          const signIn = await fetch(signInLink, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: the_owner_email,
            }),
          });
          const signInResponse = await signIn.json();
          console.log(signInResponse);
          const otp = signInResponse?.otp;

          //verify otp
          const verifyOtp = await fetch(verifyOtpLink, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: the_owner_email,
              otp,
            }),
          });
          const verifyOtpResponse = await verifyOtp.json();
          console.log(verifyOtpResponse);
          localStorage.setItem("access_token", verifyOtpResponse?.access_token);
        }

        function getMinutesBetweenTimestamps(startTimeIso, endTimeIso) {
          const startDate = new Date(startTimeIso);
          const endDate = new Date(endTimeIso);

          const diffInMilliseconds = Math.abs(
            endDate.getTime() - startDate.getTime()
          );

          // There are 60,000 milliseconds in a minute (1000 * 60)
          return Math.round(diffInMilliseconds / 60000);
        }

        const socket = new WebSocket(
          "https://blink-pay-bank-app-backend.onrender.com"
        );

        socket.onopen = () => {
          console.log("Connected to Blinkpay server", transactionRefId);
        };

        function clearDefaults() {
          localStorage.removeItem("v_account");
          localStorage.removeItem("seconds");
          localStorage.removeItem("minute");
        }
        loginToPayverge(payvergeSignin, payvergeSignInVerifyOtp);
        async function postTransactionsToPayvergeDb(
          status,
          tran_type = "card"
        ) {
          let transaction_type = tran_type;
          let amount = Number(localStorage.getItem("amount_to_send"));
          const postLink = `${BASE_URL}/api/v1/transactions`;

          try {
            status = !status ? "failed to include status" : status;

            const payload = {
              transaction_type,
              amount,
              status,
            };
            const postToDb = await fetch(postLink, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("access_token")}`,
              },
              body: JSON.stringify(payload),
            });
            const response = await postToDb.json();
            console.log(response);
          } catch (error) {
            console.error(error);
            alert(error.message);
          }
          // const
        }

        socket.onmessage = (event) => {
          try {
            const { event: evt, data } = JSON.parse(event.data);
            let txnRef = data?.transaction?.ref_id;

            console.log("WS Event:", evt, data);

            if (
              localStorage.getItem("user_id") ===
                data?.transaction?.receiver_id &&
              localStorage.getItem("payment_id") ===
                data?.transaction?.payment_id
            ) {
              if (evt === "transfer_initialized") {
                clearDefaults();
                // console.log(data);
                // console.log("initializing....")
                Swal.fire({
                  title: "Please wait...",
                  html: `
                  <p class="animate-pulse">Hold while we confirm the transfer.. </p>
                  <span> Do not refresh this page </span>
                  `,
                  icon: "info",
                });
                Swal.showLoading();
              }
              if (evt === "money_received") {
                clearDefaults();
                postTransactionsToPayvergeDb("successful", "transfer");
                // console.log(data);
                // console.log("money don enter oooo....")
                const timeout = 8000;
                setTimeout(() => {
                  Swal.close();
                }, timeout);
                setTimeout(() => {
                  Swal.fire({
                    title: "Payment Successful üéâ",
                    html: `
                    
                    `,
                    icon: "success",
                    // confirmButtonText: "Continue",
                  }).then(() => {
                    window.close();
                    window.history.back();
                  });
                }, timeout);
              }

              if (evt === "transfer_failed") {
                const timeout = 8000;
                postTransactionsToPayvergeDb("failed", "transfer");
                setTimeout(() => {
                  Swal.close();
                }, timeout);

                setTimeout(() => {
                  Swal.fire({
                    title: "Transfer Failed ‚ùå",
                    text: "Please try again later",
                    icon: "error",
                  }).then(() => {
                    clearDefaults();
                    window.close();
                    window.history.back();
                  });
                }, timeout);
              }

              if (evt === "card_payment_successful") {
                postTransactionsToPayvergeDb("successful");
                Swal.fire({
                  title: "Payment Successful üéâ",
                  html: `
                  <p><b>Amount:</b> ${Number(
                    data?.transaction?.amount || 0
                  ).toLocaleString()}</p>
                  <p><b>Reference:</b> ${localStorage.getItem("payment_id")}</p>
                  `,
                  icon: "success",
                }).then(() => {
                  window.close();
                  window.history.back();
                });
              }

              if (evt === "card_payment_failed") {
                postTransactionsToPayvergeDb("failed");
                Swal.fire({
                  title: "Payment Failed ‚ùå",
                  text: "Please try again or use another card.",
                  icon: "error",
                }).then(() => {
                  window.close();
                  window.history.back();
                });
              }
            }
          } catch (e) {
            console.error("Bad WS data", e, event.data);
          }
        };

        socket.onclose = () => {
          // console.log("Disconnected from Blinkpay server");
          console.warn("WS closed. reconecting in 5s...");
          setTimeout(() => location.reload(), 5000);
        };

        socket.onerror = (error) => {
          console.error("WebSocket error:", error);
        };

        let copyAccountNumBtn = document.querySelector("#copy-account-number");
        let copyAmountBtn = document.querySelector("#copy-amount");
        let amountValue = document.querySelector("#amount");
        let accNumber = document.querySelector("#account-number");
        let amountTransfered = document.querySelector("#amount-transfered");
        let transferTimer = document.querySelector("#timer");
        console.log(loader, whole_form);
        function c_timer(minute, seconds) {
          const timer = setInterval(() => {
            minute = Number(minute);
            seconds = Number(seconds);
            seconds -= 1;
            let time_up = false;

            if (minute === 0 && seconds === 0) {
              time_up = true;
              clearInterval(timer);
              transferTimer.textContent = "This Transfer has expired";
              localStorage.removeItem("v_account");
              localStorage.setItem("minute", minute);
              localStorage.setItem("seconds", seconds);
              localStorage.setItem("start_time", false);
              localStorage.removeItem("minute");
              localStorage.removeItem("seconds");
            }
            if (seconds === 0) {
              seconds = 59;
              minute -= 1;
            }
            let fullTime = `${String(minute).padStart(2, "0")}:${String(
              seconds
            ).padStart(2, "0")}`;
            if (!time_up) {
              // console.log(fullTime);
              transferTimer.textContent = fullTime;
              localStorage.setItem("minute", minute);
              localStorage.setItem("seconds", seconds);
            }
          }, 1000);
        }

        function countDownTimer(minutes, seconds = 60) {
          let minute = minutes;
          let minutesStorage = localStorage.getItem("minute");
          console.log(minutesStorage);
          let secondsStorage = localStorage.getItem("seconds");
          if (!secondsStorage && !minutesStorage) {
            localStorage.setItem("minute", minute);
            localStorage.setItem("seconds", seconds);
            c_timer(minute, seconds);
          } else {
            c_timer(minutesStorage, secondsStorage);
          }
        }

        function copyToClipboard(button, whereToCopyFrom, defaultText) {
          // console.log("copied")
          navigator.clipboard.writeText(whereToCopyFrom.textContent);
          button.textContent = "Copied!";
          button.disabled = true;
          button.classList.add("cursor-not-allowed");
          button.classList.add("animate-pulse");
          setTimeout(() => {
            button.disabled = false;
            button.classList.remove("animate-pulse");
            button.classList.remove("cursor-not-allowed");
            button.textContent = defaultText;
          }, 3000);
        }

        copyAccountNumBtn.addEventListener("click", () => {
          copyToClipboard(copyAccountNumBtn, accNumber, "Copy Account Number");
        });

        copyAmountBtn.addEventListener("click", () => {
          copyToClipboard(copyAmountBtn, amountTransfered, "Copy Amount");
        });

        async function fetchDataFromPaymentId(payment_id) {
          if (!payment_id) {
            return "Input Payment Id";
          }
          const response = await fetch(
            `https://payment-gateway-3.onrender.com/api/v1/get_payment?id=${payment_id}`
          );
          const data = await response.json();
          localStorage.setItem("owner_email", data?.owner_email);
          return data;
          console.log(data);
          console.log(data.message);
        }

        const {
          email: userEmail,
          amount: userAmount,
          owner_email,
        } = await fetchDataFromPaymentId(transactionRefId);

        const user = JSON.parse(localStorage.getItem("user"));

        JSON.stringify(localStorage.setItem("amount_to_send", userAmount));

        // ========= Tabs =========
        // let tabCard = document.querySelector("#tab-card");
        // let tabTransfer = document.querySelector("#tab-transfer");
        // let tabWallet = document.querySelector("#tab-wallet");
        let generated_virtual_account_amount = 0;
        let forms = {
          card: document.querySelector("#form-card"),
          transfer: document.querySelector("#form-transfer"),
          wallet: document.querySelector("#form-wallet"),
        };
        const tabs = {
          card: tabCard,
          transfer: tabTransfer,
          wallet: tabWallet,
        };

        // === CARD PAYMENT ===
        let cardNumber = document.querySelector("#card-number");
        let expiry = document.querySelector("#expiry");
        let cvv = document.querySelector("#cvv");
        let errCard = document.querySelector("#err-card");
        let errExp = document.querySelector("#err-exp");
        let errCvv = document.querySelector("#err-cvv");

        const mockNum = document.querySelector("#mock-number");
        const mockExp = document.querySelector("#mock-exp");
        const mockCvv = document.querySelector("#mock-cvv");
        // Expiry date validation
        function isExpired(mmYY) {
          const [mmS, yyS] = (mmYY || "").split("/");
          const mm = parseInt(mmS, 10);
          const yy = parseInt(yyS, 10);

          if (!mm || !yy || mm < 1 || mm > 12) return true;

          const now = new Date();
          const curM = now.getMonth() + 1;
          const curY = now.getFullYear() % 100;

          return yy < curY || (yy === curY && mm < curM);
        }

        function luhnValid(num) {
          let sum = 0,
            dbl = false;
          for (let i = num.length - 1; i >= 0; i--) {
            let d = parseInt(num[i], 10);
            if (dbl) {
              d *= 2;
              if (d > 9) d -= 9;
            }
            sum += d;
            dbl = !dbl;
          }
          return sum % 10 === 0;
        }

        // Card number input
        cardNumber.addEventListener("input", () => {
          let val = cardNumber.value.replace(/\D/g, "").slice(0, 16);
          const grouped = val.match(/.{1,4}/g)?.join("-") || val;
          cardNumber.value = grouped;
          mockNum.textContent = grouped.padEnd(19, "‚Ä¢");
          errCard.classList.add("hidden");
          cardNumber.classList.remove("border-red-500");
        });

        // Expiry input (forces MM/YY)
        expiry.addEventListener("input", () => {
          let val = expiry.value.replace(/\D/g, "");
          if (val.length === 2 && !expiry.value.includes("/")) {
            // Add slash immediately after 2 digits entered
            val = val + "/";
          } else if (val.length > 2) {
            val = val.slice(0, 2) + "/" + val.slice(2, 4);
          }

          expiry.value = val;
          mockExp.textContent = val || "MM/YY";
          errExp.classList.add("hidden");
          expiry.classList.remove("border-red-500");
        });

        // CVV input (3 digits only)
        cvv.addEventListener("input", () => {
          cvv.value = cvv.value.replace(/\D/g, "").slice(0, 3);
          mockCvv.textContent = cvv.value.replace(/./g, "*") || "***";
          errCvv.classList.add("hidden");
          cvv.classList.remove("border-red-500");
        });

        // ========= Payment Helper =========
        async function makePayment(payload, btn, btnText = "Pay Now") {
          const spinner = document.getElementById("btn-spinner");
          const text = btn.querySelector(".btn-text") || btn;
          btn.disabled = true;
          if (spinner) spinner.classList.remove("hidden");
          if (text) text.textContent = "Processing‚Ä¶";

          try {
            const res = await fetch(
              `https://payment-gateway-3.onrender.com/api/v1/make_payment`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              }
            );
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || "Request failed");
            alert(data.message || "Payment processed successfully!");
          } catch (e) {
            alert("Error: " + e.message);
          } finally {
            btn.disabled = false;
            if (spinner) spinner.classList.add("hidden");
            if (text) text.textContent = btnText;
          }
        }

        // ========= Card Submit =========
        document
          .getElementById("pay-now")
          .addEventListener("click", async () => {
            const raw = cardNumber.value.replace(/-/g, "");
            let valid = true;

            if (raw.length !== 16) {
              errCard.classList.remove("hidden");
              valid = false;
            }
            if (isExpired(expiry.value)) {
              errExp.classList.remove("hidden");
              valid = false;
            }
            if (cvv.value.length !== 3) {
              errCvv.classList.remove("hidden");
              cvv.classList.add("border-red-500");
              valid = false;
            }
            if (!valid) return;

            const btn = document.getElementById("pay-now");
            const spinner = document.getElementById("btn-spinner");
            const text = btn.querySelector(".btn-text") || btn;
            btn.disabled = true;
            spinner.classList.remove("hidden");
            text.textContent = "Processing‚Ä¶";

            try {
              const payload = {
                amount: Number(localStorage.getItem("amount_to_send")),
                pan_number: raw,
                expiry_date: expiry.value,
                cvv: cvv.value,
                payment_id: localStorage.getItem("payment_id"),
              };

              const res = await fetch(
                "https://blink-pay-bank-app-backend.onrender.com/api/v1/account/pay-with-card",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                  },
                  body: JSON.stringify(payload),
                }
              );

              const data = await res.json();
              Swal.fire({
                title: "Card Payment",
                text: data.message || "Processed",
                icon: data.success ? "success" : "error",
              });
            } catch (err) {
              Swal.fire({ title: "Error", text: err.message, icon: "error" });
            } finally {
              btn.disabled = false;
              spinner.classList.add("hidden");
              text.textContent = "Pay NGN";
            }
          });

        // === TRANSFER TAB ===
        document
          .querySelector("#tab-transfer")
          .addEventListener("click", async () => {
            console.log("clicked");
            loader.classList.remove("hidden");
            everything.classList.add("hidden");
            whole_form.classList.add("items-center");
            whole_form.classList.add("justify-center");

            const virtualAccountData = JSON.parse(
              localStorage.getItem("v_account")
            );

            try {
              let data = "";
              let amount = Number(
                JSON.parse(localStorage.getItem("amount_to_send"))
              );
              console.log(amount);
              if (!virtualAccountData) {
                const payload = {
                  amount,
                  payment_id: localStorage.getItem("payment_id"),
                };
                console.log("amount", payload);

                const res = await fetch(
                  "https://blink-pay-bank-app-backend.onrender.com/api/v1/account/create-virtual-account",
                  {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      Authorization: `Bearer ${localStorage.getItem("token")}`,
                    },
                    body: JSON.stringify(payload),
                  }
                );
                console.log("Payload:", payload);

                const generated = await res.json();
                console.log({ generated });
                console.log(amountValue);
                let v_account = JSON.stringify(generated);
                localStorage.setItem("v_account", v_account);
                data = generated;
              }

              if (!data) {
                showGeneratedPaymentDetails(virtualAccountData);
                setActive(
                  "transfer",
                  virtualAccountData.virtual_account?.amount
                );
              } else {
                showGeneratedPaymentDetails(data);
                setActive("transfer", generated_virtual_account_amount);
              }

              function showGeneratedPaymentDetails(dataToBeUsed) {
                let start_time = localStorage.getItem("start_time");

                if (dataToBeUsed?.virtual_account?.acc_number) {
                  let { createdAt, expiresAt } = dataToBeUsed?.virtual_account;
                  let minute = getMinutesBetweenTimestamps(
                    createdAt,
                    expiresAt
                  );
                  localStorage.setItem("start_time", true);
                  countDownTimer(minute);

                  if (start_time === "false") {
                    localStorage.removeItem("minute");
                    localStorage.removeItem("seconds");
                  }

                  console.log("from show generated paymenr value", amountValue);
                  amountTransfered.textContent = `${dataToBeUsed.virtual_account.amount}`;
                  loader.classList.add("hidden");
                  everything.classList.remove("hidden");
                  whole_form.classList.remove("items-center");
                  whole_form.classList.remove("justify-center");

                  let {
                    acc_number,
                    bank_name,
                    name,
                    amount: generatedAmount,
                  } = dataToBeUsed.virtual_account;

                  let bankName = document.querySelector("#bank-name");
                  let accName = document.querySelector("#account-name");

                  accNumber.textContent = acc_number;
                  bankName.textContent = bank_name;
                  accName.textContent = name;
                  amountValue.textContent = generatedAmount;
                  generated_virtual_account_amount = generatedAmount;
                  console.log({ generated_virtual_account_amount });

                  console.log("Response:", dataToBeUsed);
                } else {
                  loader.classList.add("hidden");
                  everything.classList.add("hidden");
                  whole_form.classList.remove("items-center");
                  whole_form.classList.remove("justify-center");
                  whole_form.textContent =
                    "Cannot generated account at this time";
                }
              }
            } catch (err) {
              loader.classList.add("hidden");
              everything.classList.add("hidden");
              whole_form.classList.remove("items-center");
              whole_form.classList.remove("justify-center");
              console.error(err);
              whole_form.textContent = "Try again later";
            }
          });

        // === WALLET TAB ===
        document
          .querySelector("#tab-wallet")
          .addEventListener("click", async () => {
            loader.classList.remove("hidden");
            everything.classList.add("hidden");

            try {
              // fetch wallet balance first
              const balRes = await fetch(
                "https://blink-pay-bank-app-backend.onrender.com/api/v1/account/balance",
                {
                  method: "GET",
                  headers: {
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                  },
                }
              );
              const balData = await balRes.json();

              loader.classList.add("hidden");
              everything.classList.remove("hidden");

              document.querySelector(
                "#wallet-balance"
              ).textContent = `‚Ç¶${Number(balData.balance).toLocaleString()}`;
            } catch (err) {
              loader.classList.add("hidden");
              everything.classList.remove("hidden");
              Swal.fire({
                title: "Wallet Error",
                text: "Could not fetch wallet balance.",
                icon: "error",
              });
            }
          });

        document
          .querySelector("#pay-with-wallet")
          .addEventListener("click", async () => {
            try {
              const payload = {
                amount: Number(localStorage.getItem("amount_to_send")),
                payment_id: localStorage.getItem("payment_id"),
              };

              const res = await fetch(
                "https://blink-pay-bank-app-backend.onrender.com/api/v1/account/pay-with-wallet",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                  },
                  body: JSON.stringify(payload),
                }
              );

              const data = await res.json();
              Swal.fire({
                title: "Wallet Payment",
                text: data.message || "Processed",
                icon: data.success ? "success" : "error",
              });
            } catch (err) {
              Swal.fire({ title: "Error", text: err.message, icon: "error" });
            }
          });

        // === BACK BTN ===
        document.getElementById("back-btn").addEventListener("click", () => {
          window.location.href =
            "https://payverge.netlify.app/userdashboard.html";
        });
      });
    </script>
  </body>
</html>
